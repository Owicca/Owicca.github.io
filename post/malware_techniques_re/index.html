<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="OWicca">
  <meta name="generator" content="Hugo 0.69.0-DEV" />
  <title>Malware techniques RE — Down the wabbit&#39;s hole</title>

  <meta name="description" content="">
  <link rel="canonical" href="https://www.dinudev.com/post/malware_techniques_re/">
  <link href="" rel="alternate"
    type="application/rss+xml" title="Down the wabbit&#39;s hole">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700">
  <link rel="stylesheet" href="https://www.dinudev.com/css/highlight.css">
  <link rel="stylesheet" href="https://www.dinudev.com/css/paperback.css">
  <link rel="stylesheet" href="https://www.dinudev.com//main.css">
</head>


<body>
  <div class="container">

    <header>
  
  <h1>Malware techniques RE</h1>

  
  <time datetime="2020-02-16 21:18:00 &#43;0200 EET">2020/02/16</time>
  

  
  <nav class="site-nav">
  <a href="/">Home</a>
  <a href="/post/">All posts</a>

  

  

  
</nav>

</header>

	
	
	<h3>Table of Contents</h3>
	<aside>
		<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#smashing-the-stack">Smashing the stack:</a></li>
        <li><a href="#empire">empire:</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</aside>
	
    <article>
      <h3 id="smashing-the-stack">Smashing the stack:</h3>
<ul>
<li>when you make a call, you push the address to return to onto the stack</li>
<li>overwrite that address</li>
</ul>
<h3 id="empire">empire:</h3>
<ul>
<li>
<p><strong>discontinued</strong> but a fork is currently mantained by <a href="https://github.com/BC-SECURITY/Empire">BC Security</a>:</p>
</li>
<li>
<p>launchers:</p>
<ul>
<li>powershell:</li>
</ul>
</li>
<li>
<p>stagers:</p>
<ul>
<li>backdoorLnkMacro:
<ul>
<li>backdoor .lnk on desktop that on click will attempt to download and run an empire agent</li>
<li>structure:
<ul>
<li>xls file new or with data</li>
<li>macro to be injected into the xls</li>
<li>xml holds data about empire install, this will be hosted on the c2</li>
</ul>
</li>
<li>behaviour:
<ul>
<li>two-stage macro:
<ul>
<li>stage 1: vbscript that backdoors all the .lnk on the desktop to run a pshell instance the next time they are run</li>
<li>stage 2: backdoored link will download &amp; execute an empire launcher from the xml, which will grant a reverse shell</li>
</ul>
</li>
</ul>
</li>
<li>internals:
<ul>
<li>params:
<ul>
<li>
<p>xmlVar = xml file name(random 6 char string)</p>
</li>
<li>
<p>options:
<code>'Listener' : { 'Description'   :   'Listener to generate stager for.', 'Required'      :   True, 'Value'         :   '' }, 'Language' : { 'Description'   :   'Language of the launcher to generate.', 'Required'      :   True, 'Value'         :   'powershell' }, 'TargetEXEs' : { 'Description'   :   'Will backdoor .lnk files pointing to selected executables (do not include .exe extension), enter a comma seperated list of target exe names - ex. iexplore,firefox,chrome', 'Required'      :   True, 'Value'         :   'iexplore,firefox,chrome' }, 'XmlUrl' : { 'Description'   :   'remotely-accessible URL to access the XML containing launcher code. Please try and keep this URL short, as it must fit in the given 1024 chars for args along with all other logic - default options typically allow for 100-200 chars of extra space, depending on targeted exe', 'Required'      :   True, 'Value'         :   &quot;http://&quot; + helpers.lhost() + &quot;/&quot;+xmlVar+&quot;.xml&quot; }, 'XlsOutFile' : { 'Description'   :   'XLS (incompatible with xlsx/xlsm) file to output stager payload to. If document does not exist / cannot be found a new file will be created', 'Required'      :   True, 'Value'         :   '/tmp/default.xls' }, 'OutFile' : { 'Description'   :   'File to output macro to, otherwise displayed on the screen.', 'Required'      :   False, 'Value'         :   '/tmp/macro' }, 'XmlOutFile' : { 'Description'   :   'Local path + file to output xml to.', 'Required'      :   True, 'Value'         :   '/var/www/html/'+xmlVar+'.xml' }, 'KillDate' : { 'Description'   :   'Date after which the initial powershell stub will no longer attempt to download and execute code, set this for the end of your campaign / engagement. Format mm/dd/yyyy', 'Required'      :   True, 'Value'         :   datetime.datetime.now().strftime(&quot;%m/%d/%Y&quot;) }, 'UserAgent' : { 'Description'   :   'User-agent string to use for the staging request (default, none, or other) (2nd stage).', 'Required'      :   False, 'Value'         :   'default' }, 'Proxy' : { 'Description'   :   'Proxy to use for request (default, none, or other) (2nd stage).', 'Required'      :   False, 'Value'         :   'default' }, 'StagerRetries' : { 'Description'   :   'Times for the stager to retry connecting (2nd stage).', 'Required'      :   False, 'Value'         :   '0' }, 'ProxyCreds' : { 'Description'   :   'Proxy credentials ([domain\]username:password) to use for request (default, none, or other) (2nd stage).', 'Required'      :   False, 'Value'         :   'default' }</code></p>
</li>
<li>
<p>language = from options</p>
</li>
<li>
<p>listenerName = from options</p>
</li>
<li>
<p>userAgent = from options</p>
</li>
<li>
<p>proxy = from options</p>
</li>
<li>
<p>proxyCreds = from options</p>
</li>
<li>
<p>stagerRetries = from options</p>
</li>
<li>
<p>xlsOut = from options</p>
</li>
<li>
<p>XmlPath = from options</p>
</li>
<li>
<p>XmlOut = from options</p>
</li>
<li>
<p>killDate = from options</p>
</li>
<li>
<p>targetEXE = filter(None,targetEXE)</p>
</li>
<li>
<p>shellVar = random 6 char alpha-num string</p>
</li>
<li>
<p>lnkVar = random 6 char alpha-num string</p>
</li>
<li>
<p>fsoVar = random 6 char alpha-num string</p>
</li>
<li>
<p>folderVar = random 6 char alpha-num string</p>
</li>
<li>
<p>fileVar = random 6 char alpha-num string</p>
</li>
<li>
<p>encKey = random 6 char alpha-num + digits + punctuation string</p>
</li>
<li>
<p>encIV = randint(1, 240)</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </article>

    <nav class="site-nav">
  <a href="/">Home</a>
  <a href="/post/">All posts</a>

  

  
  <a href="https://github.com/Owicca">GitHub</a>

  
</nav>


    <footer class="site-footer">
  <span class="owner">©2020 OWicca</span>

  

  
</footer>


  </div>

  
<script src="https://www.dinudev.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>

</html>
