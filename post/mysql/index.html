<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="OWicca"><meta name=generator content="Hugo 0.121.2"><title>MySQL — Down the wabbit's hole</title>
<meta name=description content><link rel=canonical href=https://www.dinudev.com/post/mysql/><link href rel=alternate type=application/rss+xml title="Down the wabbit's hole"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=https://www.dinudev.com/css/highlight.css><link rel=stylesheet href=https://www.dinudev.com/css/paperback.css><link rel=stylesheet href=https://www.dinudev.com/css/main.css><link rel=stylesheet href=https://www.dinudev.com/css/tabs.css></head><body><div class=container><header><h1>MySQL</h1><nav class=site-nav><a href=/>Home</a>
<a href=/post/>All posts</a>
<a href=/thoughts/>Thoughts</a>
<a href=/paper/>Papers</a></nav></header><h3>Table of Contents</h3><aside><nav id=TableOfContents><ul><li><ul><li><a href=#concepts>concepts:</a></li><li><a href=#myisam2innodb>myisam2innodb:</a></li><li><a href=#common>common:</a></li><li><a href=#myisam>myisam:</a></li><li><a href=#innodb>innodb:</a></li><li><a href=#maintentance>maintentance:</a></li><li><a href=#optimisations>optimisations:</a></li><li><a href=#misc>misc:</a></li><li><a href=#mariadb-audit>mariadb audit:</a></li><li><a href=#information_schema>information_schema:</a></li><li><a href=#functions>functions:</a></li><li><a href=#on-primary>on primary:</a></li><li><a href=#on-replica>on replica:</a></li><li><a href=#backup-solutions>backup solutions:</a></li><li><a href=#option-files>option files:</a></li></ul></li></ul></nav></aside><article><h3 id=concepts>concepts:</h3><ul><li>locking:<ul><li>when making changes to data, a lock is aquired that prevents any read or write
until the transaction finishes and the lock is released</li><li>if succesfull data is updated, the other transactions in the queue get to use the new data</li><li>if failed the other transactions in the queue get to use the initial data</li><li>in non-trivial systems this can be slow, because every transaction in the queue needs to wait for the others in front to finis,
making the process sequential</li></ul></li><li>multiversion concurency control:<ul><li>the system gives the readers the initial data, while the transaction is still ongoing(not fully commited)</li></ul></li><li>write-ahead-logging(WAL):<ul><li>a copy of the instructions needed for the change are first written to a safe log,
THEN the actions are done</li><li>on crash, a recovery to a stable state is made by reverting to a known valid checkpoint
and a recovery of the invalid actions is redone from the WAL</li><li>examples:<ul><li>journaling in fs</li><li>transactions in db</li></ul></li></ul></li><li>shadow paging:<ul><li>a page is a fixed size blob that contains data</li><li>when starting a transaction, a page is created and only pointed to by the transaction manager,
when the transaction is completed, the pointer to the old page is changed with the pointer to the new page,
if the transaction failed, the shadow page is simply deleted</li></ul></li></ul><h3 id=myisam2innodb>myisam2innodb:</h3><ol><li>[] every table should have a primary key</li><li>[] innodb can have deadlocks even if there are no transactions</li></ol><h3 id=common>common:</h3><ul><li>b-tree index</li><li>full-text searches</li></ul><h3 id=myisam>myisam:</h3><ul><li>lock: table</li><li>cache:<ul><li>only keys (by loading the .MYI file in memory)</li></ul></li></ul><h3 id=innodb>innodb:</h3><ul><li>lock: row</li><li>cache:<ul><li>keys & data pages loaded from disk</li></ul></li><li>only here:<ul><li>clustered index: yes</li><li>data cache: yes<ul><li>caches data in buffer pool</li><li>caches indexes</li></ul></li><li>ACID compliant: yes<ul><li>foreign key</li><li>transactions</li></ul></li></ul></li></ul><h3 id=maintentance>maintentance:</h3><ul><li>both:<ul><li>CHECK TABLE: checks if there are errors</li><li>REPAIR TABLE: repairs a broken table</li><li>OPTIMIZE TABLE: orders indexes and data on disk for lower disk usage and faster access time</li><li>ANALYZE TABLE: update statistics(eg: used in predicting amounts of rows to be scanned)</li></ul></li></ul><h3 id=optimisations>optimisations:</h3><ul><li>myisam:<ul><li><code>ROW_FORMAT=FIXED</code> (transforms varchars in fixed-length chars)</li><li>myisam has table locking, therefore is only good for read-only/high-read tables</li></ul></li><li>innodb:<ul><li>indexes:<ul><li>cluster by primary key</li><li>add primary key in all indexes</li><li>use primary key in joins</li><li>low amount of indexes</li></ul></li><li>os:<ul><li>if using <code>innodb_file_per_table</code> also use linux <code>noatime</code>(dont write access time to file), <code>nodiratime</code>(dont write access time to dir):<ul><li>atime: when a <code>read</code> happens, the access time is updated, therefore a <code>write</code> also happens</li></ul></li><li>change scheduler to Noop/Deadline(?!?!)</li></ul></li><li>mysqldump is slow for innodb</li><li><code>innodb_buffer_pool_size</code> should be ~70-80% of available RAM</li></ul></li><li>binary copy of myisam db files to other server is safe, not for innodb</li><li>tell OS to never swap mysql memory</li></ul><h3 id=misc>misc:</h3><ul><li>use innoDB for everything except read-heady cache tables</li><li>innodb optimisation settings:</li></ul><pre tabindex=0><code>innodb_open_files = 500
innodb_file_per_table
innodb_buffer_pool_size = 250M
innodb_flush_log_at_trx_commit = 2
innodb_thread_concurrency =8
innodb_lock_wait_timeout = 500
interactive_timeout = 20
back_log = 75
table_cache = 300
thread_cache = 32
thread_concurrency = 8
wait_timeout = 30
connect_timeout = 10
</code></pre><ul><li>myisam <code>key_buffer_size</code> formula:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> CONCAT(ROUND(KBS<span style=color:#f92672>/</span>POWER(<span style=color:#ae81ff>1024</span>,
</span></span><span style=display:flex><span><span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024)))<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>4999</span>),
</span></span><span style=display:flex><span>SUBSTR(<span style=color:#e6db74>&#39; KMG&#39;</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span><span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024))<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>recommended_key_buffer_size <span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>SELECT</span> LEAST(POWER(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>32</span>),KBS1) KBS
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>SUM</span>(index_length) KBS1
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> information_schema.tables
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> engine<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;MyISAM&#39;</span> <span style=color:#66d9ef>AND</span>
</span></span><span style=display:flex><span>table_schema <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#39;information_schema&#39;</span>,<span style=color:#e6db74>&#39;mysql&#39;</span>)) AA ) A,
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>2</span> PowerOf1024) B;
</span></span></code></pre></div><ul><li>innodb <code>innodb_buffer_pool_size</code> formula:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> CONCAT(ROUND(KBS<span style=color:#f92672>/</span>POWER(<span style=color:#ae81ff>1024</span>,
</span></span><span style=display:flex><span><span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024)))<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>49999</span>),
</span></span><span style=display:flex><span>SUBSTR(<span style=color:#e6db74>&#39; KMG&#39;</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span><span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024))<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>)) recommended_innodb_buffer_pool_size
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>SUM</span>(data_length<span style=color:#f92672>+</span>index_length) KBS <span style=color:#66d9ef>FROM</span> information_schema.tables
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> engine<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;InnoDB&#39;</span>) A,
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>2</span> PowerOf1024) B;
</span></span></code></pre></div><ul><li>resize innodb log files:<ol><li>Add innodb_log_file_size=NNN to /etc/my.cnf (NNN should be 25% of innodb_buffer_pool_size or 2047M, whichever is smaller)</li><li>service mysql stop</li><li>rm /var/log/mysql/ib_logfile[01]</li><li>service mysql start (ib_logfile0 and ib_logfile1 are recreated)</li></ol></li><li>innodb disk storage info:</li><li>pool size examples:</li></ul><pre tabindex=0><code>If you have 2GB RAM and 16GB of InnoDB, allocate 512M as innodb_buffer_pool.
If you have 2GB RAM and 4GB of MyISAM Indexes, allocate 512M as key_buffer_size.
If you have 2GB RAM and 4GB of MyISAM Indexes and 16GB InnoDB, allocate 512M as key_buffer_size and 512M as innodb_buffer_pool_size.
Possible scenarios are endless !!!

Remember, whatever you allocate for, leave enough RAM for DB Connections and the Operating System.
InnoDB does not store tables as a heap.

InnoDB tables are always stored as a clustered index, where the clustered index is the primary key. A table-scan is therefore more or less equivalent to an index-scan of the clustered index.

Any index in InnoDB is not usually stored sequentially on disk. It&#39;s stored as a collection of pages, where page have a uniform size of 16KB. The index is obviously much larger than this, and over time insertions and updates expand parts of the index in the middle as well as at the end. To do this efficiently (that is, without needing to rewrite the whole table), random insertions and updates result in the pages being out of order. New pages created are placed wherever there is room in the file.

To facilitate scanning through all the pages, each page contains links to the location of the next page and the preceding page. These may be quite far away in the file, so a table-scan will not actually be sequential, it will involve many seeks to other locations in the file.

InnoDB requires that pages are loaded into RAM before it can actually use them in queries. The InnoDB buffer pool is a fixed-size allocation of RAM, which contains a set of pages loaded from disk. Once the pages are in the buffer pool, they can be accessed very quickly, and with virtually no overhead for following links. The overhead of reading a page from disk into the buffer pool is orders of magnitude much greater than reading a page once it is in RAM.

So in the case of MySQL:

There is no heap
Sequential order by clustered index has nothing to do with sequential storage on disk
Reads are made to pages in RAM anyway, so the physical layout on disk has little to do with the order pages will be read
</code></pre><h3 id=mariadb-audit>mariadb audit:</h3><ul><li>events:<ul><li><code>connect</code>: connects, disconnects and failed connects</li><li><code>query</code>: queries and their results (dql: data query language)</li><li><code>tables</code>: tables affected by queries</li><li><code>query_ddl</code>: only DDL(data definition language) queries(create, drop, rename, alter and truncate)</li><li><code>query_dml</code>: only DML(data manipulation language) <code>do, call, load data/xml, delete, insert, select, update, handler, replace</code></li><li><code>query_dml_no_select</code>: like <code>query_dml</code>, but no select</li><li><code>query_dcl</code>: only DCL(data control language) <code>create user, drop user, rename user, grant, revoke, set password</code></li></ul></li><li>log format:<ul><li>timestamp</li><li>host</li><li>user</li><li>connecting host</li><li>connection id</li><li>thread id</li><li>operation</li><li>db</li><li>sql</li><li>return code: 0, otherwise an error</li></ul></li></ul><h3 id=information_schema>information_schema:</h3><ul><li>innodb_*:<ul><li>innodb-related tables</li></ul></li><li>all_plugins</li><li>character_sets:<ul><li>all available charsets and collations</li></ul></li><li>check_constraints</li><li>client_statistics</li><li>collation_character_set_applicability</li><li>collations</li><li>column_privileges</li><li>columns</li><li>disks</li><li>enabled_roles</li><li>engines</li><li>events</li><li>feedback</li><li>files</li><li>geometry_columns</li><li>global_status</li><li>session_status</li><li>global_variables</li><li>session_variables</li><li>index_statistics</li><li>key_caches</li><li>key_column_usage</li><li>keywords</li><li>locales</li><li>metadata_lock_info</li><li>mroonga_stats</li><li>optimizer_trace</li><li>parameters</li><li>partitions</li><li>plugins</li><li>processlist</li><li>profiling</li><li>query_cache_info</li><li>query_response_time</li><li>referential_constraints</li><li>routines</li><li>schemata</li><li>spatial_ref_sys</li><li>spider_alloc_mem</li><li>spider_wrapper_protocols</li><li>sql_functions</li><li>statistics</li><li>system_variables</li><li>table_constraints</li><li>table_privileges</li><li>table_statistics</li><li>tables</li><li>tablespaces</li><li>thread_pool_groups</li><li>thread_pool_queues</li><li>thread_pool_stats</li><li>thread_pool_waits</li><li>triggers</li><li>user_privileges</li><li>user_statistics</li><li>user_variables</li><li>views</li><li>wsrep_membership</li><li>wsrep_status</li></ul><h3 id=functions>functions:</h3><ul><li>string:<ul><li><code>CAST(expr AS type)</code>: cast a value to a type</li><li><code>CHARACTER_LENGTH(str)</code>: get length of string</li><li><code>CONCAT(str1[, str2][, strN])</code>:<ul><li>concat multiple strings</li><li>if any of the strings is <code>NULL</code>, the result is also <code>NULL</code></li></ul></li><li><code>CONCAT_WS(sep, str1[, str2][, strN])</code>:<ul><li>concat multiple strings with a separator</li><li>if separator is <code>NULL</code>, the result is also <code>NULL</code></li><li><code>NULL</code> strings are skipped</li></ul></li><li><code>FROM_BASE64(str)</code> / <code>TO_BASE64(str)</code></li><li><code>HEX(N)</code> / <code>UNHEX(str)</code>: get hex representation of bigint</li><li><code>INSERT(dest, pos, len, src)</code>: insert <code>src</code> at <code>pos</code> for <code>len</code> in <code>dest</code></li><li><code>LOCATE(sub, str)</code>: get index of first position of <code>sub</code> in <code>str</code></li><li><code>LOCATE(sub, str, pos)</code>: get index of first position of <code>sub</code> in <code>str</code> starting from <code>pos</code></li><li><code>LOWER(str)</code> / <code>UPPER(str)</code></li><li><code>LEFT(str, len)</code> / <code>RIGHT(str, len)</code>: return left/right-most <code>len</code> of characters</li><li><code>LIKE</code> / <code>NOT LIKE</code>:<ul><li>operators in template:<ul><li><code>%</code>: matches 0, 1 or more chars</li><li><code>_</code>: matches one char</li></ul></li><li>misc:<ul><li>like is case-insensitive, to force case-sensitive matches use <code>COLLATE</code>:<ul><li><code>column LIKE '%a%' COLLATE utf8mb4_unicode_ci</code></li></ul></li><li>to optimize like don&rsquo;t start with &lsquo;%&rsquo; or &lsquo;_&rsquo;</li></ul></li><li><code>expr LIKE '16____'</code>: a filter that returns column that contains 6 characters, &lsquo;16&rsquo; followed by other 4 characters</li></ul></li><li><code>LOAD_FILE(file_path)</code>: load contents of a file</li><li><code>LPAD(str, len[, padstr])</code> / <code>RPAD(str, len[, padstr])</code>: pad <code>str</code> for <code>len</code> with char <code>padstr</code>, if no padstr, space is used</li><li><code>QUOTE(str)</code>: escape string</li><li><code>REPEAT(str, count)</code>: repeat <code>str</code>, <code>count</code> times</li><li><code>REPLACE(str, from, to)</code>:<ul><li>replace <code>from</code> with <code>to</code> in <code>str</code></li><li><code>from</code> search is case-sensitive</li></ul></li><li><code>REVERSE(str)</code>: reverse <code>str</code></li><li><code>SPACE(N)</code>: return a space repeated <code>N</code> times</li><li><code>STRCMP(expr1, expr2)</code>:<ul><li>compare <code>expr1</code> and <code>expr2</code>:<ul><li>0 if both are equal</li><li>-1 if expr1 is smaller</li><li>1 if expr2 is smaller</li></ul></li></ul></li><li><code>SUBSTRING(str, pos[, len])</code>:<ul><li>return <code>len</code> chars from <code>str</code> starting from <code>pos</code></li><li>if pos is negative, it is counted from the end of the string</li><li>if any argument is <code>NULL</code>, the result is <code>NULL</code></li></ul></li><li><code>TRIM([{BOTH | LEADING | TRAILING} [to_remove] FROM] str)</code>:<ul><li>misc:<ul><li>if <code>to_remove</code> is not provided, trim whitespace</li><li>if <code>BOTH</code>, <code>LEADING</code> or <code>TRAILING</code> are not provided, default is <code>BOTH</code></li></ul></li><li>examples:<ul><li><code>TRIM('-a b ')</code>: &lsquo;-a b&rsquo;</li><li><code>TRIM(LEADING '-a b ')</code>: &lsquo;-a b '</li><li><code>TIME(BOTH '-' FROM '-a b ')</code>: &lsquo;a b '</li></ul></li></ul></li><li><code>COMPRESS(plain)</code> / <code>UNCOMPRESS(encrypted)</code>:<ul><li>if variable <code>have_compress</code>(mysql is not compiled with zlib support) is NO, func will always return NULL</li></ul></li></ul></li><li>number:<ul><li><code>ABS(N)</code></li><li><code>FLOOR(N)</code> / <code>CEILING(N)</code></li><li><code>CONV(N, from, to)</code>:<ul><li>convert <code>N</code> from base <code>from</code> to base <code>to</code></li><li>examples:<ul><li><code>CONV(10, 10, 2)</code> == <code>BIN(10)</code></li><li><code>CONV(10, 10, 8)</code> == <code>OCT(10)</code></li><li><code>CONV(10, 10, 16)</code> == <code>HEX(10)</code></li></ul></li></ul></li><li><code>LEAST(N1, N2[, Nn])</code> / <code>GREATEST(N1, N2(, Nn))</code>: min and max</li><li><code>POW(X, Y)</code></li><li><code>ROUND(F[, N])</code>: round <code>F</code> to nearest <code>N</code> digits, N is 0 by default</li><li><code>TRUNCATE(F[, N])</code>: truncate numbers of digits of <code>F</code> to nearest <code>N</code> digits</li><li><code>SIGN(X)</code>:<ul><li>negative: -1</li><li>0: 0</li><li>positive: +1</li></ul></li></ul></li><li>control flow:<ul><li><code>CASE</code>:<ul><li><code>CASE val WHEN c1 THEN s1 WHEN c2 THEN s2 END</code></li></ul></li><li><code>IF(expr1, then, else)</code>: if <code>expr1</code> is not 0 or NULL, execute <code>then</code>, else <code>else</code></li><li><code>IFNULL(expr1, default)</code>: if <code>expr1</code> is not null return it, otherwise <code>default</code></li></ul></li><li>date & time:<ul><li>types:<ul><li><code>DATE</code>:<ul><li>format: &lsquo;YYYY-MM-DD&rsquo;</li></ul></li><li><code>TIME</code>:<ul><li>format: &lsquo;HH:MM:SS.ssssss&rsquo;</li></ul></li><li><code>DATETIME</code>:<ul><li>format: &lsquo;YYYY-MM-DD HH:MM:SS.ffffff&rsquo;</li><li>range: &lsquo;0000-00-00 00:00:00.000000&rsquo; - &lsquo;9999-12-31 23:59:59.999999&rsquo;</li><li>saves value as is, does not account for timezone</li></ul></li><li><code>TIMESTAMP</code>:<ul><li>format: &lsquo;YYYY-MM-DD HH:MM:SS.ffffff&rsquo;</li><li>range: &lsquo;1970-01-01 00:00:00.000001&rsquo; - &lsquo;2038-01-09 03-14-17&rsquo;</li><li>converts to utc then saves values,
you will get different values based on connection timezone and <code>time_zone</code> system variable</li></ul></li></ul></li><li><code>INTERVAL N_S QUALIFIER</code>:<ul><li><code>N_S</code>: a number or a compound value(&lsquo;1:2&rsquo;, &lsquo;5:3&rsquo;)</li><li><code>QUALIFIER</code>:<ul><li><code>MICROSECOND</code></li><li><code>SECOND</code></li><li><code>MINUTE</code></li><li><code>HOUR</code></li><li><code>DAY</code></li><li><code>WEEK</code></li><li><code>MONTH</code></li><li><code>YEAR</code></li></ul></li><li>examples:<ul><li><code>select '1970-01-01T00:00:00.000000' + INTERVAL 1 MONTH</code>: &lsquo;1970-02-01T00:00:00.000000&rsquo;</li></ul></li></ul></li><li><code>FROM_UNIXTIME(N[, format])</code>: get a date from unix timestamp bigint <code>N</code>, optionally formated based on <code>format</code></li><li><code>NOW([N])</code> / <code>CURRENT_TIMESTAMP([N])</code>: return <code>DATETIME</code> with optional microsecond precision of <code>N</code> length</li><li><code>UTC_TIMESTAMP([N])</code>: return <code>TIMESTAMP</code> with optional microsecond precision of <code>N</code> length</li><li><code>CONVERT_TZ(dt, from, to)</code>:<ul><li>convert datetime <code>dt</code> from timezone <code>from</code> to timezone <code>to</code></li><li>examples:<ul><li><code>CONVERT_TZ(dt, '+00:00', '+10:00')</code></li></ul></li></ul></li><li><code>EXTRACT(temporal_type FROM dt)</code>: get specified <code>temporal_type</code> from date <code>dt</code></li><li><code>DATE_FORMAT(date, format)</code> / <code>STR_TO_DATE(str, format)</code>: convert date to string and back again</li></ul></li><li>aggregate related:<ul><li><code>FOUND_ROWS</code>:<ul><li><code>SELECT SQL_CALC_FOUND_ROWS * FROM table; SELECT FOUND_ROWS();</code></li></ul></li></ul></li><li>information related:<ul><li><code>CHARSET(str)</code> / <code>COLLATION(str)</code>: get charset/collation of string</li><li><code>CONNECTION_ID()</code></li><li><code>CURRENT_USER()</code> / <code>CURRENT_ROLE()</code>: get current user/role</li><li><code>USER()</code>: get connected client user(<a href=mailto:user@host.network>user@host.network</a>)</li><li><code>DATABASE()</code>: get current connected db</li><li><code>VERSION()</code>: get application version</li></ul></li><li>replication:<ul><li><code>START SLAVE [connection_name] [thread_type [, thread_type]]</code> / <code>STOP SLAVE [connection_name] [thread_type [, thread_type]]</code>:<ul><li>if connection_name is not provided, the main configured primary connection is used</li><li>start/stop specified slave threads:<ul><li><code>IO_THREAD</code>: the thread that copies events from the master to the relay log</li><li><code>SQL_THREAD</code>: the thread that reads the relay log and executes the events on the slave</li></ul></li></ul></li><li><code>RESET SLAVE</code>:<ul><li>forget replica&rsquo;s position in the primary binlog</li><li>used for a clean start</li></ul></li></ul></li><li>miscelaneous:<ul><li><code>SHOW [GLOBAL | SESSION] STATUS [LIKE 'pattern' | WHERE expr]</code>:<ul><li>equivalent of <code>SELECT * FROM information_schema.global_status</code> / <code>SELECT * FROM information_schema.session_status</code></li><li>show connection status</li><li>can filter by category:<ul><li><code>GLOBAL</code></li><li><code>SESSION</code></li></ul></li><li>can filter with like and where</li></ul></li><li><code>SLEEP(N)</code>: pause the execution for <code>N</code> seconds</li><li><code>UUID()</code>: return a 128bit uuid(v1) type</li><li><code>UUID_SHORT()</code>: return a 64bit(v1) integer</li></ul></li></ul><h3 id=on-primary>on primary:</h3><ol><li>enable binlog in settings</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[mariadb]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log-bin # enable binary logging</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server_id</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1 # a unique id is needed</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log-basename</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>market_prd1 # by default basename is hostname, this prevents errors when hostname is changed</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>binlog-format</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>mixed # default</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_binlog_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1073741824 # default: 1G; max size of each binlog file, before rotating to a new one</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_bin_compress</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>OFF # default</span>
</span></span></code></pre></div><ol start=2><li>create replication user:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>USER</span> <span style=color:#e6db74>&#39;market_prd_wsu_replication&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span> IDENTIFIED <span style=color:#66d9ef>BY</span> <span style=color:#e6db74>&#39;replication&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>GRANT</span> REPLICATION SLAVE <span style=color:#66d9ef>ON</span> <span style=color:#f92672>*</span>.<span style=color:#f92672>*</span> <span style=color:#66d9ef>TO</span> <span style=color:#e6db74>&#39;market_prd_wsu_replication&#39;</span><span style=color:#f92672>@</span><span style=color:#e6db74>&#39;%&#39;</span>;
</span></span></code></pre></div><ol start=3><li>get master <strong>file</strong> and last <strong>pos</strong>:</li></ol><pre tabindex=0><code>SHOW MASTER STATUS;
</code></pre><h3 id=on-replica>on replica:</h3><ol><li>set config:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[mariadb]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server_id</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>relay_log</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>market_prd2-bin</span>
</span></span></code></pre></div><ol start=2><li>set connection settings and enable slave:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>STOP SLAVE;
</span></span><span style=display:flex><span><span style=color:#66d9ef>RESET</span> SLAVE;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CHANGE MASTER <span style=color:#66d9ef>TO</span>
</span></span><span style=display:flex><span>MASTER_HOST<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;sp44.local&#39;</span>,
</span></span><span style=display:flex><span>MASTER_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;market_prd_wsu_replication&#39;</span>,
</span></span><span style=display:flex><span>MASTER_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;root&#39;</span>,
</span></span><span style=display:flex><span>MASTER_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>3306</span>,
</span></span><span style=display:flex><span>MASTER_LOG_FILE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;market_prd1-bin.000001&#39;</span>,
</span></span><span style=display:flex><span>MASTER_LOG_POS<span style=color:#f92672>=</span><span style=color:#ae81ff>703</span>,
</span></span><span style=display:flex><span>MASTER_CONNECT_RETRY<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>START</span> SLAVE;
</span></span></code></pre></div><ol start=3><li>check if replication is working by checking for <strong>Yes</strong> in <code>Slave_IO_Running</code> and <code>Slave_SQL_Running</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SHOW</span> SLAVE STATUS;
</span></span></code></pre></div><h3 id=backup-solutions>backup solutions:</h3><ul><li>physical:<ul><li><code>mariabackup</code>:<ul><li>copies/restores the contents of &lsquo;/var/lib/mysql/&rsquo;</li><li>pros:<ul><li>quick backup</li><li>supports incremental backups</li></ul></li><li>cons:<ul><li>restoring requires a restart</li><li>restore is only reliable on db of exact same version</li></ul></li></ul></li></ul></li><li>logical:<ul><li><code>mysqldump</code>:<ul><li>exports db contents as sql statements</li><li>pros:<ul><li>can be restored on multiple db versions, or even different databases(sqlite, postgres, etc)</li></ul></li></ul></li></ul></li><li>fs-level:<ul><li>partition backup</li><li>lvm/xfs/zfs backup</li></ul></li><li>os-level:<ul><li>vm snapshot</li></ul></li></ul><h3 id=option-files>option files:</h3><ul><li>dashes and underscores are interchangeable</li><li>groups:<ul><li>server:<ul><li><code>[client-server]</code>: client and servers</li><li><code>[mysqld]</code>: mysqld(mariadb and mysql)</li><li><code>[server]</code>: mariadb</li><li><code>[mariadbd]</code>: mariadb</li><li><code>[mariadb]</code>: mariadb</li><li><code>[mysqld-X.Y]</code>: mysqld version <code>X.Y</code></li><li><code>[mariadb-X.Y]</code>: mariadb version <code>X.Y</code></li><li><code>[mariadbd-X.Y]</code>: mariadb version <code>X.Y</code></li><li><code>[galera]</code>: mariadb compiled with galera cluster support</li></ul></li></ul></li><li>client:<ul><li><code>[client]</code></li><li><code>[client-server]</code></li><li><code>[client-mariadb]</code></li></ul></li><li>directives:<ul><li><code>!include &lt;/path/to/config/file.cnf></code></li><li><code>!includedir &lt;/path/to/config/dir/></code></li></ul></li></ul></article><nav class=site-nav><a href=https://www.dinudev.com//>Home</a>
<a href=https://www.dinudev.com//post/>All posts</a>
<a href=https://www.dinudev.com//thoughts/>Thoughts</a>
<a href=https://www.dinudev.com//paper/>Papers</a>
<a href=https://github.com/Owicca>GitHub</a></nav><footer class=site-footer><span class=owner>©2024 OWicca</span></footer></div><script src=https://www.dinudev.com/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://www.dinudev.com/js/tabs.js></script></body></html>