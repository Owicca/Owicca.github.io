<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="OWicca"><meta name=generator content="Hugo 0.121.2"><title>Containers — Down the wabbit's hole</title>
<meta name=description content><link rel=canonical href=https://www.dinudev.com/post/containers/><link href rel=alternate type=application/rss+xml title="Down the wabbit's hole"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=https://www.dinudev.com/css/highlight.css><link rel=stylesheet href=https://www.dinudev.com/css/paperback.css><link rel=stylesheet href=https://www.dinudev.com/css/main.css><link rel=stylesheet href=https://www.dinudev.com/css/tabs.css></head><body><div class=container><header><h1>Containers</h1><nav class=site-nav><a href=/>Home</a>
<a href=/post/>All posts</a>
<a href=/thoughts/>Thoughts</a>
<a href=/paper/>Papers</a></nav></header><h3>Table of Contents</h3><aside><nav id=TableOfContents><ul><li><ul><li><a href=#docker>docker:</a></li><li><a href=#oci-image>oci image:</a></li><li><a href=#oci-runtime>oci runtime:</a></li><li><a href=#oci-container>oci container:</a></li><li><a href=#runc--lxc>runc / lxc:</a></li><li><a href=#containerd>containerd:</a></li><li><a href=#moby>moby:</a></li><li><a href=#docker-1>docker:</a></li></ul></li></ul></nav></aside><article><h3 id=docker>docker:</h3><ol><li><input checked disabled type=checkbox> image-spec</li><li>[] runtime-spec</li><li><input checked disabled type=checkbox> runc</li><li><input checked disabled type=checkbox> containerd</li><li><input checked disabled type=checkbox> moby</li></ol><h3 id=oci-image>oci image:</h3><ul><li>info:<ul><li>a description of one or more root fs changes and commands to be run in a container runtime</li><li>a layer does not have metadata, only content</li><li>metadata such as env variables or default arguments belong to the image as a whole</li><li>image json description structure:<ul><li>date created</li><li>author</li><li>arch</li><li>os</li><li>os.version</li><li>os.features</li><li>variant</li><li>runtime configuration:<ul><li>user</li><li>exposed ports</li><li>env</li><li>entrypoint</li><li>default arguments(cmd)</li><li>volumes</li><li>working dir</li><li>labels</li><li>stop signal</li><li>networking</li></ul></li><li>layers:<ul><li>an array of hashes that will make up the runtime fs</li></ul></li></ul></li><li>changing any data in the json description, it will change the ImageId, creating a derived image</li><li>an image&rsquo;s ImageID is a sha256 of its json description</li></ul></li><li>structure:<ul><li>image manifest:<ul><li>metadata of contents and dependencies for a single image for an architecture for an operating system</li><li>main purpose:<ol><li>content-addresable images:<ul><li>hash the content and use the hash as an id to directly address that version of image</li></ul></li><li>multi-architecture images:<ul><li>contain references to manifests for specific platforms(image index)</li></ul></li><li>can be translated to a runtime configuration</li></ol></li></ul></li><li>image index(optional):<ul><li>high-level manifest that points to other manifests that usually help in building for different platforms</li><li>a list of image manifests for different configurations/platforms</li></ul></li><li>image configuration:<ul><li>app arguments</li><li>environment variables</li></ul></li><li>one or more fs serializations:<ul><li>data that will be pointed by an image manifest</li><li>deserialized by the runtime</li><li>layers(changesets):<ul><li>info:<ul><li>a set of changes is tarred</li><li>when applying the changeset:<ul><li>if there are no whiteouts,
the tar is simply extracted on top of the root fs,
esentially adding/modifying files</li><li>if there are whiteouts, the tar is <code>applied</code>,
rather than simply extracted</li></ul></li><li>every layer is contained in a directory named for its digest(CAS)</li></ul></li><li>stored as:<ul><li>tar</li><li>tar gzipped</li><li>tar zstd(compressed with zstd)</li></ul></li><li>change types:<ul><li>addition</li><li>modification</li><li>removal:<ul><li>an empty file, signifying it should be deleted</li><li>a whiteout</li><li>a file that has a name of <code>.wh.&lt;original_filename></code></li></ul></li></ul></li><li>file types:<ul><li>regular file</li><li>directory</li><li>socket</li><li>symbolic link</li><li>block device</li><li>character device</li><li>FIFO</li></ul></li><li>file attributes:<ul><li>mtime: modification time</li><li>uid</li><li>gid</li><li>mode</li><li>xattrs: extended attributes</li><li>linkname(+ symbolic link type)</li><li>linkname(hardlink)</li></ul></li></ul></li></ul></li></ul></li></ul><h3 id=oci-runtime>oci runtime:</h3><ul><li>info:<ul><li>a runtime must be able to create the execution enviroment and manage the lifecycle of a container</li><li>the purpose of a runtime is to take the image description and convert it into an usable execution environment:<ul><li>use the layer description to create a fs for the container</li><li>use the config to populate the environment with metadata</li></ul></li><li>a running container is located in /var/lib/docker/&lt;driver_name:overlay2>/</li></ul></li><li>content:<ul><li><code>/lower/</code>(LowerDir):<ul><li>read-only layers that built the container</li><li>image layers assembled in order</li></ul></li><li><code>/diff/</code>(UpperDir):<ul><li>read-write layer(last layer)</li></ul></li><li><code>/merged/</code>(main dir):<ul><li>a merge of lower and diff in which the container makes changes</li><li>the runtime effectively chroots in this dir</li></ul></li></ul></li></ul><h3 id=oci-container>oci container:</h3><ul><li>info:<ul><li>principles:<ol><li>encapsulate a software component</li><li>encapsulate the software component&rsquo;s dependencies</li><li>the way the encapsulation is made should be self-describing and portable</li></ol></li><li>the container aims to be the standardized way of delivery of a software package</li></ul></li></ul><ol><li>standard operations:<ul><li>using standard container tools:<ul><li>create</li><li>start</li><li>stop</li></ul></li><li>using standard fs tools:<ul><li>copy</li><li>snapshot</li></ul></li><li>using standard network tools:<ul><li>download</li><li>upload</li></ul></li></ul></li><li>content agnostic:<ul><li>the same container lifecycle irresponsible of the content</li></ul></li><li>infrastructure agnostic:<ul><li>on the same container can be used every operation described,
on every platform described/supported</li><li>this ensures exact replication,
even if you create on windows,
copy on linux, upload from linux,
download and start from arm</li></ul></li></ol><h3 id=runc--lxc>runc / lxc:</h3><ul><li>standardized wrappers over os specific virtualization apis</li></ul><h3 id=containerd>containerd:</h3><ul><li>container runtime</li><li>responsabilities:<ul><li>content:<ul><li>cas storage and retrieval</li></ul></li><li>snapshot(?!?!)</li><li>diff:<ul><li>generate and apply diffs between layers</li></ul></li><li>images:<ul><li>image management(download, storage, retrieval)</li></ul></li><li>containers:<ul><li>container management</li><li>a container is just a metadata context</li></ul></li><li>tasks:<ul><li>here, containerd delegates to runc/lxc</li><li>tasks ARE the runtime that exists in a container(a context)</li><li>tasks wrap processes using cgroups</li></ul></li><li>events:<ul><li>a pub/sub system that feeds info on important changes in a container&rsquo;s lifecycle</li></ul></li><li>introspection:<ul><li>query description of various parts of the runtime</li></ul></li></ul></li></ul><h3 id=moby>moby:</h3><ul><li>docker upstream</li><li>essentialy is the main docker engine</li></ul><h3 id=docker-1>docker:</h3><ul><li>structure:<ul><li>moby</li><li>docker-cli</li><li>docker packaging repo(glue code that creates the public releases)</li></ul></li></ul></article><nav class=site-nav><a href=https://www.dinudev.com//>Home</a>
<a href=https://www.dinudev.com//post/>All posts</a>
<a href=https://www.dinudev.com//thoughts/>Thoughts</a>
<a href=https://www.dinudev.com//paper/>Papers</a>
<a href=https://github.com/Owicca>GitHub</a></nav><footer class=site-footer><span class=owner>©2024 OWicca</span></footer></div><script src=https://www.dinudev.com/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://www.dinudev.com/js/tabs.js></script></body></html>