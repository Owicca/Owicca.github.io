<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="OWicca">
  <meta name="generator" content="Hugo 0.58.0-DEV" />
  <title>Windows — Down the wabbit&#39;s hole</title>

  <meta name="description" content="">
  <link rel="canonical" href="https://www.dinudev.com/post/windows/">
  <link href="" rel="alternate"
    type="application/rss+xml" title="Down the wabbit&#39;s hole">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700">
  <link rel="stylesheet" href="https://www.dinudev.com/css/highlight.css">
  <link rel="stylesheet" href="https://www.dinudev.com/css/paperback.css">
  <link rel="stylesheet" href="https://www.dinudev.com//main.css">
</head>


<body>
  <div class="container">

    <header>
  <h1>Windows</h1>

  
    <time datetime="2020-03-16 00:00:00 &#43;0000 UTC">Post created: 16 Mar 2020</time>
    <time datetime="2020-07-18 00:00:00 &#43;0000 UTC">Last updated: <b>18 Jul 2020</b></time>
  

  <nav class="site-nav">
  <a href="/">Home</a>
  <a href="/post/">All posts</a>

  

  

  
</nav>

  
</header>

    <article>
      

<h3 id="major-versions">Major Versions:</h3>

<ul>
<li>XP(2001) 5.1</li>
<li>Vista(2007) 6.0</li>
<li>7(2009) 6.1</li>
<li>8(2012) 6.2</li>
<li>8.1(2013) 6.3</li>
<li>10(2015) 10</li>
</ul>

<h3 id="component-object-model-com">Component Object Model(COM):</h3>

<ul>
<li>originally created to enable Office apps to communicate and exchange data between documents
(Object Linking and Embedding - OLE)</li>
<li>principles:

<ul>
<li>clients communicate with objects(COM server objects) through interfaces</li>
<li>component implementation is loaded dynamically rather than begin statically linked to the client</li>
</ul></li>
<li>it tipically refers to a DLL or EXE where the COM classes are implemented</li>
</ul>

<h3 id="windows-runtime-winrt">Windows Runtime(WinRT):</h3>

<ul>
<li>platform services aimed particularlly at app developers for Windows Apps(Windows Store Apps)</li>
<li>can target multiple device form factors(IoT, phones, tablets, desktops, xbox, hololens)</li>
<li>built on top of COM</li>
</ul>

<h3 id="net-framework">.NET Framework:</h3>

<ul>
<li>Common Language Runtime(CLR):

<ul>
<li>a JIT that translates CIL(Common Intermediate Language) to the underlying hardware CPU machine language</li>
<li>a garbage collector</li>
<li>type verification</li>
<li>code access security</li>
<li>etc</li>
</ul></li>
<li>.Net Framework Class Library(FCL):

<ul>
<li>large collection of types that implement functionality needed by the client or server applications:

<ul>
<li>user interfaces</li>
<li>networking</li>
<li>database access</li>
<li>etc</li>
</ul></li>
</ul></li>
</ul>

<h3 id="service">Service:</h3>

<ul>
<li>a callable routine in the OS</li>
<li>a device driver</li>
<li>a server process</li>
</ul>

<h3 id="process">Process:</h3>

<ul>
<li>a program is a static sequence of instructions</li>
<li>a process is a container for a set of resources used when executing the instance of the program</li>
<li>structure:

<ul>
<li>virtual private address</li>
<li>executable program: initial data and code mapped in the process&rsquo;s vm</li>
<li>a list of open handles: mapping to system resources
(semaphores, synchronization objects, files) accessible to all threads in the process</li>
<li>a security context(access token):

<ul>
<li>user</li>
<li>security groups</li>
<li>privileges</li>
<li>attributes</li>
<li>claims</li>
<li>capabilities</li>
<li>UAC(User Account Control) virtualization state</li>
<li>session</li>
<li>limited user account state associated with the process</li>
<li>AppContainer identifier(and related sandboxing information)</li>
</ul></li>
<li>a process ID: unique identifier</li>
<li>at least one thread of execution</li>
</ul></li>
</ul>

<h3 id="thread">Thread:</h3>

<ul>
<li>an entity in a process Windows schedules for execution</li>
<li>structure:

<ul>
<li>contents of a set of CPU registers representing the state of the processor</li>
<li>two stacks(one for execution in kernel mode and the other for user mode execution)</li>
<li>thread-local storage for use by subsystems, run-time libraries and DLLs</li>
<li>thread ID(unique identifier)</li>
<li>sometimes their own security context or token</li>
</ul></li>
<li>thread context(volatile registers, stacks and thread-local storage;
<code>GetThreadContext</code> returns a <code>CONTEXT</code>;<code>Wow64GetThreadContext</code>)</li>
<li>switching between two threads gets expensive:

<ul>
<li>fibers(lightweight threads): allow an application to schedule its own threads of execution:

<ul>
<li><code>ConvertThreadToFiber</code>;<code>CreateFiber</code>;<code>SwitchToFiber</code></li>
<li>they are invisible to the kernel</li>
<li>issues sharing thread-local storage(several fibers can be running on the same thread)</li>
<li>cannot run concurently on more than one processor</li>
</ul></li>
<li>user-mode scheduling threads:

<ul>
<li>only available in x64</li>
</ul></li>
</ul></li>
</ul>

<h3 id="job">Job:</h3>

<ul>
<li>extension of a process</li>
<li>management and manipulation of groups of processes as a unit</li>
<li>compensates for the lack of a process tree</li>
</ul>

<h3 id="virtual-memory">Virtual Memory:</h3>

<ul>
<li>pages:

<ul>
<li>default size of 4KB</li>
</ul></li>
<li>in x86:

<ul>
<li>0x0000 0000 to 0x7FFF FFFF are used for processes</li>
<li>0x8000 0000 to 0xFFFF FFFF is protected for the OS</li>
</ul></li>
<li>Address Windowing Extension(AWE): 32-bit can allocate up to 64 GB of physical memory and map views
into its vm</li>
</ul>

<h3 id="terminal-services">Terminal Services:</h3>

<ul>
<li>windows equivalent to X Windowing system remote desktop</li>
<li>run application on a host and send the display on another</li>
</ul>

<h3 id="registry">Registry:</h3>

<ul>
<li>structure:

<ul>
<li>system database that contains information required to boot and configure the system</li>
<li>system-wide software settings that control the operation of Windows</li>
<li>the security database</li>
<li>per-user configuration settings</li>
<li>access to in-memory volatile data</li>
</ul></li>
<li>HKEY_LOCAL_MACHINE(HKLM): system-wide configuration hive</li>
</ul>

<h3 id="security">Security:</h3>

<ul>
<li>process integrity levels:

<ul>
<li>the process must have at least the same integrity level as the object it operates on, to be allowed to change it</li>
<li>hierarchy:

<ul>
<li>system</li>
<li>high(eleveated administrator process)</li>
<li>medium(default;standard processes and objects created by the user)</li>
<li>low(Internet Explorer)</li>
<li>untrusted(Google Chrome)</li>
</ul></li>
</ul></li>
<li><strong>AppContainer</strong>:

<ul>
<li>aplication sandboxing</li>
<li>blocks processes from writing and reading outside of its boundaries: the AppContainer</li>
<li>by default an app can access only its install folder and subfolders</li>
<li>other access paths are defined while installing(capability activation) or after, with explicit user interaction</li>
<li>it is a SID(security identifier)</li>
<li>capabilities:

<ul>
<li>library: access to a specific library</li>
<li>device: access to the microphone, camera, GPS and removable storage</li>
<li>network: access to lan or wan</li>
<li>identity: access to use the user credentials</li>
<li>system: show notifications, show status in the backround and run in the backround when the system is locked</li>
</ul></li>
<li>apps have access to a selection of broker processes to execute certain operations outside the appcontainer boundaries</li>
</ul></li>
<li><strong>AppLocker</strong>:

<ul>
<li>application whitelising based on path, publisher, hash or group policy:

<ul>
<li>rules based on file attributes(publisher name, product name,
file name, file version, file path, file hash)</li>
<li>assign a rule to a security group or individual user</li>
<li>create exceptions to rules</li>
<li>can use audit-only mode to deploy the policy and understand its impact before inforcing it</li>
<li>can create and manage rules in powershell</li>
</ul></li>
<li>control which apps and files users can run</li>
<li>bypass techniques:

<ul>
<li>write an unapproved program to a whitelisted location</li>
<li>use an whitelisted program as a delegate to launch an unapproved program</li>
<li>hijack the DLLs loaded by a trusted application in an untrusted directory</li>
</ul></li>
</ul></li>
<li><strong>Device Guard</strong>:

<ul>
<li>block all apps that are considered to not be trusted, allows only apps from the store,
selected software vendors, and signed line-of-business applications to run</li>
<li>line <strong>AppLocker</strong> but it segregates the process that determines wether the apps are trusted or not</li>
<li>it runs in virtual secure mode with the elf of LSA(Local Security Authority),
and is isolated from the os using hardware-assisted virtualization</li>
<li>it won&rsquo;t be able to protect from JIT code(java, document macros)</li>
</ul></li>
<li>Microsoft <strong>Passport</strong>:

<ul>
<li>single sign-in service</li>
<li>a wallet for fast, convenient online purchases</li>
</ul></li>
<li>Microsoft <strong>Hello</strong>():

<ul>
<li>biometric authentication: face or fingerprint</li>
<li>pin for every device</li>
</ul></li>
<li><strong>Software Restriction Policies</strong>(SRP):

<ul>
<li>group policy-based feature</li>
<li>identifies software programs running on computers in a domain</li>
<li>controls the ability of those programs to run</li>
<li><strong>local group policy editor</strong></li>
</ul></li>
</ul>

<h3 id="boot">BOOT:</h3>

<ul>
<li>Physical Address Extension(PAE):

<ul>
<li>x86 can only use a maximum of 4GB of RAM</li>
<li>with PAE enabled it can access up to 64GB</li>
<li>x86_64 does this natively so pae is not needed there</li>
</ul></li>
<li>Data Execution Prevention(DEP):

<ul>
<li>mark one or more pages of memory as non-executable(data pages)</li>
<li>protects agains buffer overruns</li>
<li>prevents code from begin run from default heap, stacks, and memory pools</li>
<li>if there is an attempt to execute code from an DEP marked page,
a memory access violation exception occurs, and if it is not handled,
the calling process is terminated</li>
</ul></li>
</ul>

<h3 id="kernel-memory-space">Kernel memory space:</h3>

<ul>
<li>Paged and Nonpaged Pools:

<ul>
<li>kernel-mode heaps used by all the kernel components</li>
<li>paged is the default allocation storage</li>
<li>nonpaged is used for areas that are forbidden to be flushed to the disk</li>
</ul></li>
<li>System cache:

<ul>
<li>where the cache manager maps all the currently cached files</li>
<li>when a file is opened, a cached copy is made in the system cacche and
when the file is accessed, the data is first accessed from the system cache copy</li>
</ul></li>
<li>Terminal Services Session Space:

<ul>
<li>component that allows for multiple, remote GUI sessions on a single system</li>
</ul></li>
<li>Page Tables:

<ul>
<li>virtual-memory mapping of currently active page tables</li>
</ul></li>
<li>Hyper Space:

<ul>
<li>mapping the current process&rsquo;s working set</li>
</ul></li>
<li>System Working Set:

<ul>
<li>global data structure that manages systems physical memory use(pageable memory only)</li>
<li>kernel memory space contains pageable memory(system cache, paged pool), this manages it</li>
</ul></li>
<li>System Page-Table Entries(PTE):

<ul>
<li>used for large kernel allocations of any kind</li>
<li><code>MmAllocateMappingAddress</code></li>
</ul></li>
<li>extra:

<ul>
<li>Section Objects(memory mapped files):

<ul>
<li>special chunk of memory managed by the operating system</li>
<li>types:

<ul>
<li>Pagefile-Backend:

<ul>
<li>temporary storage of information</li>
<li>share data between two or more processes/between applications and the kernel</li>
<li>it can be paged out to a pagefile</li>
</ul></li>
<li>File-Backend:

<ul>
<li>a mapping of a physical file into memory</li>
<li>instead of using ReadFile/WriteFile, a simple pointer to the mapping can be passed and used</li>
</ul></li>
</ul></li>
</ul></li>
<li>Virtual Address Descriptor(VAD) Tree:

<ul>
<li>binary tree that describes every address range that is curently in use by a process</li>
<li>types:

<ul>
<li>mapped allocation:

<ul>
<li>memory mapped files mapped into the address space(section objects and loaded executables)</li>
</ul></li>
<li>private allocation:

<ul>
<li>allocations local to each process: heaps, thread stacks</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<h3 id="user-mode-memory-allocations">User-mode Memory Allocations:</h3>

<ul>
<li>Private Allocations:

<ul>
<li>when using <code>VirtualAlloc</code></li>
<li>alocates hole pages</li>
<li>used for stacks and heaps</li>
<li>types:

<ul>
<li>Heaps:

<ul>
<li>every heap allocation will call this: <code>VirtualAlloc</code></li>
<li>heaps provided by the win32 api: <code>HeapAlloc</code>, <code>HeapFree</code></li>
<li>heaps provided by runtime libraries: <code>malloc</code></li>
</ul></li>
<li>Stacks:

<ul>
<li>regular private allocations</li>
<li>one for every thread</li>
</ul></li>
<li>Executables:

<ul>
<li>system runs an application code by loading it into memory as a memory-mapped file</li>
</ul></li>
<li>Mapped Views(Sections):

<ul>
<li>create a memory-mapped file and load it into your address space(can be used as a shared memory space)</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<h3 id="memory-management-apis">Memory Management APIs:</h3>

<ul>
<li>this process:

<ul>
<li>VirtualAlloc</li>
<li>VirtualProtect</li>
<li>VirtualQuery</li>
<li>VirtualFree</li>
</ul></li>
<li>another process:

<ul>
<li>VirtualAllocEx</li>
<li>VirtualProtectEx</li>
<li>VirtualQueryEx</li>
<li>VirtualFreeEx</li>
</ul></li>
<li>dedicated api:

<ul>
<li><code>ReadProcessMemory</code></li>
<li><code>WriteProcessMemory</code></li>
</ul></li>
<li>section object related:

<ul>
<li><code>CreateFileMapping</code></li>
<li><code>MapViewOfFileEx</code></li>
<li><code>UnmapViewOfFile</code></li>
</ul></li>
</ul>

<h3 id="kernel-objects-and-handles">Kernel objects and handles:</h3>

<ul>
<li>sections, files, device objects, synchronization objects, processes and threads</li>
<li>data structures stored in the non-paged pool</li>
</ul>

<h3 id="processes-and-threads">Processes and Threads:</h3>

<ul>
<li>process initialization:

<ul>
<li><code>CreateProcess</code>:

<ul>
<li>create process object</li>
<li>allocate new memory address space for the process</li>
<li>map NTDLL.DLL and the program executable in the created address space</li>
<li>create first thread and allocate stack space for it</li>
</ul></li>
<li>first thread runs in NTDLL.DLL&rsquo;s LdrpInitialize</li>
<li>LdrpInitialize recursivelly maps all the executables that are needed(from the import tables)</li>
<li>now LdrpRunInitializeRoutines that initializes(call the entrypoint with DLL_PROCESS_ATTACH constant)
all the staticly linked dlls in the current address space</li>
<li>after dll initialization LdrpInitialize calls BaseProcessStart from KERNEL32.DLL,
which calls the executables WinMain</li>
</ul></li>
</ul>

<h3 id="win32-api">Win32 API:</h3>

<ul>
<li>Kernel</li>
<li>User</li>
<li>GDI</li>
</ul>

    </article>

    <nav class="site-nav">
  <a href="/">Home</a>
  <a href="/post/">All posts</a>

  

  
  <a href="https://github.com/Owicca">GitHub</a>

  
</nav>


    <footer class="site-footer">
  <span class="owner">©2020 OWicca</span>

  

  
</footer>


  </div>

  
<script src="https://www.dinudev.com/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>

</html>
